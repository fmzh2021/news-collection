name: 新闻采集工具

on:
  # 仅手动触发，避免push时循环构建
  workflow_dispatch:
    inputs:
      keyword:
        description: '搜索关键字'
        required: true
        type: string
      platforms:
        description: '搜索平台 (用逗号分隔: toutiao,google,bing)'
        required: false
        default: 'toutiao,google,bing'
        type: string

jobs:
  scrape-news:
    runs-on: ubuntu-latest
    # 添加权限配置，允许写入gh-pages分支
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: 安装依赖
      run: |
        pip install -r requirements.txt
    
    - name: 安装Playwright浏览器
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: 运行新闻采集
      env:
        KEYWORD: ${{ github.event.inputs.keyword }}
        PLATFORMS: ${{ github.event.inputs.platforms }}
      run: |
        KEYWORD="${KEYWORD:-测试}"
        PLATFORMS="${PLATFORMS:-toutiao,google,bing}"
        python scraper.py "$KEYWORD" "$PLATFORMS"
    
    - name: 上传结果文件
      uses: actions/upload-artifact@v4
      with:
        name: news-results-${{ github.run_id }}
        path: |
          results_*.json
          results_latest.json
        retention-days: 30
    
    - name: 输出结果文件路径
      id: result_file
      run: |
        RESULT_FILE=$(ls -t results_*.json | head -1)
        echo "result_file=$RESULT_FILE" >> $GITHUB_OUTPUT
        echo "结果文件: $RESULT_FILE"
    
    - name: 安装jq
      run: sudo apt-get install -y jq
    
    - name: 创建结果摘要
      run: |
        RESULT_FILE=$(ls -t results_*.json | head -1)
        if [ -f "$RESULT_FILE" ]; then
          TOTAL=$(jq '.total' "$RESULT_FILE")
          KEYWORD=$(jq -r '.keyword' "$RESULT_FILE")
          echo "## 新闻采集结果" >> $GITHUB_STEP_SUMMARY
          echo "- **关键字**: $KEYWORD" >> $GITHUB_STEP_SUMMARY
          echo "- **总数**: $TOTAL 条" >> $GITHUB_STEP_SUMMARY
          echo "- **结果文件**: \`$RESULT_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **下载**: 在 Artifacts 中下载 \`news-results-${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: 准备API文件
      run: |
        mkdir -p api
        cp results_*.json api/ 2>/dev/null || true
        cp results_latest.json api/ 2>/dev/null || true
        # 如果index.html不存在，创建一个简单的
        if [ ! -f api/index.html ]; then
          cat > api/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻采集API</title>
</head>
<body>
    <h1>新闻采集API接口</h1>
    <p>获取最新结果: <a href="results_latest.json">results_latest.json</a></p>
</body>
</html>
EOF
        fi
    
    - name: 部署到GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./api
        keep_files: true
        # 使用GITHUB_TOKEN而不是PAT，避免权限问题
        cname: false