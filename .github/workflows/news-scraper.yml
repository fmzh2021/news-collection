name: 新闻采集工具

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      keyword:
        description: '搜索关键字'
        required: true
        type: string
      platforms:
        description: '搜索平台 (用逗号分隔: toutiao,google,bing)'
        required: false
        default: 'toutiao,google,bing'
        type: string
  # 定时触发 - 每天9点（北京时间）执行
  # GitHub Actions 使用 UTC 时间，北京时间9点 = UTC 1点
  schedule:
    - cron: '0 1 * * *'  # UTC 1点 = 北京时间9点

jobs:
  scrape-news:
    runs-on: ubuntu-latest
    # 添加权限配置，允许写入gh-pages分支
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: 安装依赖
      run: |
        pip install -r requirements.txt
    
    - name: 安装Playwright浏览器
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: 运行新闻采集
      env:
        # workflow_dispatch 触发时会使用用户输入，schedule 触发时使用默认值
        KEYWORD: ${{ github.event.inputs.keyword }}
        PLATFORMS: ${{ github.event.inputs.platforms }}
      run: |
        # 定时触发时默认关键字为"中公教育"，手动触发时使用用户输入
        KEYWORD="${KEYWORD:-中公教育}"
        PLATFORMS="${PLATFORMS:-toutiao,google,bing}"
        echo "搜索关键字: $KEYWORD"
        echo "搜索平台: $PLATFORMS"
        python scraper.py "$KEYWORD" "$PLATFORMS" || {
          echo "错误: 新闻采集脚本执行失败" >&2
          exit 1
        }
    
    - name: 上传结果文件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: news-results-${{ github.run_id }}
        path: |
          results_*.json
          results_latest.json
        retention-days: 30
        if-no-files-found: warn
    
    - name: 输出结果文件路径
      id: result_file
      run: |
        if ls results_*.json 1> /dev/null 2>&1; then
          RESULT_FILE=$(ls -t results_*.json | head -1)
          echo "result_file=$RESULT_FILE" >> $GITHUB_OUTPUT
          echo "结果文件: $RESULT_FILE"
        else
          echo "警告: 未找到结果文件" >&2
          echo "result_file=" >> $GITHUB_OUTPUT
        fi
    
    - name: 安装jq
      run: sudo apt-get install -y jq
    
    - name: 创建结果摘要
      run: |
        if ls results_*.json 1> /dev/null 2>&1; then
          RESULT_FILE=$(ls -t results_*.json | head -1)
          if [ -f "$RESULT_FILE" ]; then
            TOTAL=$(jq '.total' "$RESULT_FILE")
            KEYWORD=$(jq -r '.keyword' "$RESULT_FILE")
            echo "## 新闻采集结果" >> $GITHUB_STEP_SUMMARY
            echo "- **关键字**: $KEYWORD" >> $GITHUB_STEP_SUMMARY
            echo "- **总数**: $TOTAL 条" >> $GITHUB_STEP_SUMMARY
            echo "- **结果文件**: \`$RESULT_FILE\`" >> $GITHUB_STEP_SUMMARY
            echo "- **下载**: 在 Artifacts 中下载 \`news-results-${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## 新闻采集结果" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️ **警告**: 未找到结果文件，可能采集过程中出现错误" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: 准备API文件
      run: |
        mkdir -p api
        cp results_*.json api/ 2>/dev/null || true
        cp results_latest.json api/ 2>/dev/null || true
        # 如果index.html不存在，创建一个简单的
        if [ ! -f api/index.html ]; then
          echo '<!DOCTYPE html>' > api/index.html
          echo '<html lang="zh-CN">' >> api/index.html
          echo '<head>' >> api/index.html
          echo '    <meta charset="UTF-8">' >> api/index.html
          echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> api/index.html
          echo '    <title>新闻采集API</title>' >> api/index.html
          echo '</head>' >> api/index.html
          echo '<body>' >> api/index.html
          echo '    <h1>新闻采集API接口</h1>' >> api/index.html
          echo '    <p>获取最新结果: <a href="results_latest.json">results_latest.json</a></p>' >> api/index.html
          echo '</body>' >> api/index.html
          echo '</html>' >> api/index.html
        fi
    
    - name: 部署到GitHub Pages
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && (success() || failure())
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./api
        keep_files: true
        # 使用GITHUB_TOKEN而不是PAT，避免权限问题
        cname: false